<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Vui h·ªçc ph√©p nh√¢n</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
      :root {
        --bg: #fff9f2;
        --card: #fff;
        --accent: #ff8c94;
        --accent2: #ffd166;
        --text: #3b3b3b;
        --shadow: 0 8px 20px rgba(38, 38, 38, 0.08);
        font-family: "Baloo 2", sans-serif;

      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: linear-gradient(180deg, var(--bg), #fff5f0);
        color: var(--text);
      }
      .app {
        max-width: 980px;
        margin: 20px auto;
        padding: 20px;
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .logo {
        width: 84px;
        height: 84px;
        border-radius: 18px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
      }
      h1 {
        font-size: 28px;
        margin: 0;
      }
      p.lead {
        margin: 4px 0 16px;
        color: #5b5b5b;
      }

      .controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 18px;
      }
      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 12px;
        box-shadow: var(--shadow);
      }

      .control-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      label {
        font-weight: 600;
      }
      input[type="range"] {
        width: 220px;
      }
      .big {
        font-size: 20px;
        font-weight: 700;
      }

      .visual {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .canvas {
        flex: 1;
        background: linear-gradient(180deg, #fff, #fffcf9);
        border-radius: 12px;
        padding: 14px;
        min-height: 220px;
      }

      .groups {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .group {
        background: #fff5f6;
        border-radius: 10px;
        padding: 8px;
        min-width: 78px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.04);
      }
      .items {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
      }
      .item {
        width: 42px;
        height: 42px;
        border-radius: 6px;
        background: linear-gradient(180deg, #fff, #ffecec);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }

      .right {
        width: 320px;
      }
      .equation {
        font-size: 40px;
        font-weight: 800;
        margin: 8px 0;
      }
      .result {
        font-size: 40px;
        color: var(--accent);
        font-weight: 900;
      }

      .btn {
        display: inline-block;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--accent);
        color: white;
        text-decoration: none;
        cursor: pointer;
        border: none;
      }
      .btn.secondary {
        background: #ffd166;
        color: #4b3621;
      }
      .quiz {
        margin-top: 14px;
      }

      footer {
        margin-top: 18px;
        font-size: 13px;
        color: #666;
      }

      /* mobile tweaks */
      @media (max-width: 900px) {
        .visual {
          flex-direction: column;
        }
        .right {
          width: 100%;
        }
      }

      /* --- Multiplication Table Cute Style --- */
      #multiplicationButtons button {
        background: #ffd8e4;
        border: none;
        padding: 10px 14px;
        margin: 5px;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.25s;
      }

      #multiplicationButtons button.active {
        background: #ff5fa2;
        color: white;
        transform: scale(1.15);
      }

      #multiplicationButtons button:hover {
        background: #ff9bc4;
      }

      #multiplicationDisplay {
        margin-top: 18px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* M·ªói d√≤ng b·∫£ng nh√¢n */
     #multiplicationDisplay div {
        font-size: 24px;   /* nh·ªè l·∫°i v·ª´a ƒë·ªß cho b√© nh√¨n */
        font-weight: 600;
        padding: 10px 14px;
        border-radius: 12px;
        background: rgba(255,255,255,0.7);
        transition: transform .2s, background .2s;
        }

    #multiplicationDisplay div:hover {
        transform: scale(1.05);
        background: rgba(255,255,255,0.95);
        }


      #multiplicationDisplay div:active {
        transform: scale(1.12);
      }

      /* N√∫t ƒë·ªçc b·∫£ng */
      #readTableBtn {
        margin-top: 15px;
        background: #ff5fa2;
        color: white;
        font-size: 20px;
        padding: 12px 18px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: 0.25s;
      }

      #readTableBtn:hover {
        background: #ff3f87;
      }

      /* Game Cards */
      #gameArea {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-top: 20px;
      }

      .game-card {
        background: #fff7db;
        border: 2px solid #f0c66d;
        border-radius: 12px;
        font-size: 26px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        user-select: none;
      }

      .game-card.matched {
        background: #baffc4;
        border-color: #57b86a;
        cursor: default;
        transform: scale(1.05);
      }

      .game-card:hover:not(.matched) {
        background: #ffe9a7;
        transform: scale(1.08);
      }

      #newGameBtn {
        margin-top: 15px;
        background: #ffb100;
        color: #fff;
        font-size: 20px;
        padding: 10px 18px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
      }

      #newGameBtn:hover {
        background: #ff9a00;
      }

      #timerDisplay.blink {
        animation: blink 0.6s infinite;
      }

      @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: .3; }
        100% { opacity: 1; }
      }

      .sticker-earned {
        font-size: 60px;
        animation: pop 0.7s ease-out;
      }

      @keyframes pop {
        0% { transform: scale(0.3); opacity: 0; }
        70% { transform: scale(1.4); opacity: 1; }
        100% { transform: scale(1); }
      }

      #tablesSection {
        display: none;
      }

      /* small helper for fade */
      .fade {
        transition: opacity 220ms ease, transform 220ms ease;
      }

      body, button, input {
        font-size: 18px;
    }

    /* --- B·∫£ng c·ª≠u ch∆∞∆°ng d·∫°ng th·∫ª ƒë·∫πp --- */
#multiplicationDisplay {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

#multiplicationDisplay div {
  background: #fff7fb;
  border: 2px solid #ffbad8;
  border-radius: 14px;
  padding: 14px 8px;
  font-size: 22px;
  font-weight: 700;
  text-align: center;
  transition: transform .2s, background .2s;
}

#multiplicationDisplay div:hover {
  transform: scale(1.08);
  background: #ffe6f1;
}

/* --- Game v√πng 4 c·ªôt ƒë·ªÅu & ƒë·∫πp --- */
#gameArea {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 20px;
}
.game-card {
  background: #fffce6;
  border: 2px solid #ffd777;
  border-radius: 14px;
  padding: 14px 8px; /* gi·∫£m chi·ªÅu cao */
  font-size: 24px;
  text-align: center;
  cursor: pointer;
  transition: 0.25s;
  user-select: none;

  /* Thay ƒë·ªïi h√¨nh d·∫°ng t·ª´ d·ªçc ‚Üí ngang */
  height: 70px;           
  display: flex;
  justify-content: center;
  align-items: center;
}


.game-card:hover:not(.matched) {
  background: #ffefb7;
  transform: scale(1.06);
}

.game-card.matched {
  background: #bbffcd;
  border-color: #39b55a;
  transform: scale(1.1);
}

    </style>
  </head>

  <body>
    <div class="app">
      <header>
        <div class="logo" aria-hidden>
          <span style="font-size: 60px">ü¶Å</span>
        </div>
        <div style="flex:1;">
          <h1>Vui h·ªçc ph√©p nh√¢n</h1>
          <p class="lead">
            Ph√©p nh√¢n l√† m·ªôt c√°ch t√≠nh g·ªçn khi ch√∫ng ta c·ªông nhi·ªÅu l·∫ßn m·ªôt s·ªë
            gi·ªëng nhau.
          </p>

          <div style="margin-top:12px; display:flex; gap:12px;">
            <button id="modeLearning" class="btn">L√†m quen ph√©p nh√¢n</button>
            <button id="modeTables" class="btn secondary">H·ªçc b·∫£ng c·ª≠u ch∆∞∆°ng</button>
          </div>
        </div>
      </header>

      <!-- LEARN SECTION -->
      <div id="learnSection" class="fade" style="margin-top:16px;">
        <section class="controls" aria-label="ƒêi·ªÅu khi·ªÉn">
          <div class="card control-item">
            <label for="groupsCount">S·ªë nh√≥m: <span id="gVal" class="big">3</span></label>
            <input id="groupsCount" type="range" min="1" max="8" value="3" />
          </div>

          <div class="card control-item">
            <label for="itemsPerGroup">S·ªë v·∫≠t trong m·ªói nh√≥m: <span id="iVal" class="big">4</span></label>
            <input id="itemsPerGroup" type="range" min="1" max="8" value="4" />
          </div>

          <div class="card control-item" style="padding: 10px 12px; justify-content: center">
            <label style="opacity: 0.8">S·ª± v·∫≠t:</label>
            <div style="display: flex; gap: 8px; align-items: center">
              <button class="btn secondary" id="prevIcon" aria-label="tr∆∞·ªõc">‚óÄ</button>
              <div id="iconPreview" style="width:58px;height:58px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:28px;">üçé</div>
              <button class="btn secondary" id="nextIcon" aria-label="sau">‚ñ∂</button>
            </div>
          </div>
        </section>

        <div class="visual" style="margin-top:12px;">
          <div class="canvas card" id="canvas" style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:800; font-size:24px">Nh√≥m v√† v·∫≠t</div>
              </div>
              <div style="font-size:12px; color:#888">Ch·∫°m v√†o ƒë·ªì ƒë·ªÉ ƒë·∫øm</div>
            </div>

            <div class="groups" id="groupsArea" style="margin-top: 12px"></div>

            <div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between;">
              <div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <div class="equation" id="equation">$1</div>
                  <button class="btn" id="speakBtn">üîä</button>
                </div>
                <div>ƒê·ªçc: <span id="spoken" style="font-weight:700">Ba nh√¢n b·ªën</span></div>
              </div>
              <div style="text-align:right;">
                <div style="font-size:13px; color:#666">T·ªïng s·ªë</div>
                <div class="result" id="totalCount">12</div>
              </div>
            </div>

            <hr style="margin:12px 0; border:none; border-top:1px dashed #eee" />

            <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
              <div style="display:flex; gap:8px;">
                <button class="btn secondary" id="resetBtn">ƒê·∫∑t l·∫°i</button>
                <button class="btn" id="shuffleBtn">V√≠ d·ª• kh√°c</button>
              </div>
              <div style="font-size:13px; color:#666">K·∫øt qu·∫£ hi·ªán t·∫°i cho b√© nh√¨n, nghe v√† ƒë·∫øm.</div>
            </div>
          </div>

          <aside class="right">
            <div class="card">
              <div style="font-weight:800">B√†i t·∫≠p nh·ªè</div>
              <div class="quiz" id="quizArea">
                <div style="margin-top:8px">S·ªë ƒë·ªÅ: <span id="quizStep">1</span>/5</div>
                <div id="quizQuestion" style="margin-top:10px; font-size:24px; font-weight:700">M·∫•y nh√≥m? M·∫•y v·∫≠t m·ªói nh√≥m?</div>
                <button class="btn" id="speakQuizBtn">üîä</button>

                <div style="margin-top:10px; display:flex; gap:8px;">
                  <button class="btn" id="answerA">A</button>
                  <button class="btn secondary" id="answerB">B</button>
                </div>
                <div id="quizFeedback" style="margin-top:8px; height:22px"></div>
                <button class="btn secondary" id="retryQuizBtn" style="margin-top:10px; display:none;">üîÑ Th·ª±c h√†nh l·∫°i</button>
              </div>
            </div>
          </aside>
        </div>
      </div>

      <!-- TABLES & GAME SECTION -->
     
      <div id="tablesSection" class="fade" style="margin-top:16px;">
        <div class="visual">
                    <div style="flex:1;">
                    <div class="card" style="margin-top:12px;"">
                <div style="font-weight:800; margin-bottom:6px">üìö Ch·ªçn b·∫£ng nh√¢n</div>

                <div id="multiplicationButtons" style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;"></div>

                <div id="multiplicationDisplay" style="padding:10px; background:#fffdf7; border-radius:10px;"></div>

                <button class="btn" id="readTableBtn" style="margin-top:12px; width:100%;">üîä ƒê·ªçc t·∫•t c·∫£ b·∫£ng</button>
                    </div>
                    </div>
            <aside class="right" style="flex-shrink:0;">
                <h2 style="margin-top: 16px;">üéÆ Tr√≤ ch∆°i: L·∫≠t th·∫ª t√¨m c·∫∑p ƒë√∫ng</h2>
                <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center;">
                    <div id="timerDisplay" style="font-size:22px; font-weight:700; color:#ff5e5e;">‚è±Ô∏è 30s</div>
                    <div id="stickerDisplay" style="font-size:26px;">üéÅ Sticker: <span id="stickerCount">0</span> ‚≠ê</div>
                </div>
                <div id="gameArea"></div>
                <button id="newGameBtn" class="btn secondary" style="margin-top:12px;">Ch∆°i V√°n M·ªõi</button>

                
            </aside>
        </div>
    </div>

      <footer>
        G·ª£i √Ω: b·∫Øt ƒë·∫ßu b·∫±ng ƒë·ªì th·∫≠t (k·∫πo, b√∫t). Sau b√© hi·ªÉu, d√πng ·ª©ng d·ª•ng n√†y
        ƒë·ªÉ luy·ªán nh·∫≠n bi·∫øt nhanh.
      </footer>
    </div>

    <script>
      // --------------------------
      // DOM refs
      // --------------------------
      const icons = ["üçé", "üç™", "üê∂", "üê±", "üçì", "üçå", "üåü", "üç©"];
      let iconIndex = 0;
      const groupsCountEl = document.getElementById("groupsCount");
      const itemsPerGroupEl = document.getElementById("itemsPerGroup");
      const groupsArea = document.getElementById("groupsArea");
      const gVal = document.getElementById("gVal");
      const iVal = document.getElementById("iVal");
      const equation = document.getElementById("equation");
      const totalCount = document.getElementById("totalCount");
      const spoken = document.getElementById("spoken");
      const iconPreview = document.getElementById("iconPreview");
      const prevIcon = document.getElementById("prevIcon");
      const nextIcon = document.getElementById("nextIcon");
      const speakBtn = document.getElementById("speakBtn");
      const resetBtn = document.getElementById("resetBtn");
      const shuffleBtn = document.getElementById("shuffleBtn");

      const quizStep = document.getElementById("quizStep");
      const quizQuestion = document.getElementById("quizQuestion");
      const answerA = document.getElementById("answerA");
      const answerB = document.getElementById("answerB");
      const quizFeedback = document.getElementById("quizFeedback");
      const speakQuizBtn = document.getElementById("speakQuizBtn");
      const retryQuizBtn = document.getElementById("retryQuizBtn");

      const learnSection = document.getElementById("learnSection");
      const tablesSection = document.getElementById("tablesSection");
      const modeLearning = document.getElementById("modeLearning");
      const modeTables = document.getElementById("modeTables");

      // --------------------------
      // small helpers
      // --------------------------
      function speak(text) {
        if (!("speechSynthesis" in window)) return;
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = "vi-VN";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(ut);
      }

      // --------------------------
      // Mode switching
      // --------------------------
      function showLearn() {
        learnSection.style.display = "block";
        tablesSection.style.display = "none";
        modeLearning.classList.remove("secondary");
        modeTables.classList.add("secondary");
      }
      function showTables() {
        learnSection.style.display = "none";
        tablesSection.style.display = "block";
        modeTables.classList.remove("secondary");
        modeLearning.classList.add("secondary");
        // ensure table/game inits when showing tables
        if (!multiplicationButtonsHasChildren()) initMultiplicationButtons();
        updateTable(currentTable);
        createGame();
      }
      modeLearning.addEventListener("click", showLearn);
      modeTables.addEventListener("click", showTables);

      // --------------------------
      // Groups render (learn)
      // --------------------------
      function updatePreview() {
        iconPreview.textContent = icons[iconIndex];
      }
      function toVietnamese(n) {
        const map = ["kh√¥ng","m·ªôt","hai","ba","b·ªën","nƒÉm","s√°u","b·∫£y","t√°m","ch√≠n"];
        if (n < 10) return map[n] || n;
        return String(n);
      }
      function renderGroups() {
        const g = Number(groupsCountEl.value);
        const i = Number(itemsPerGroupEl.value);
        gVal.textContent = g;
        iVal.textContent = i;
        equation.textContent = `${g} √ó ${i}`;
        spoken.textContent = toVietnamese(g) + " nh√¢n " + toVietnamese(i);
        totalCount.textContent = g * i;

        groupsArea.innerHTML = "";
        for (let x = 0; x < g; x++) {
          const gEl = document.createElement("div");
          gEl.className = "group";
          const title = document.createElement("div");
          title.style.fontWeight = "700";
          title.textContent = `Nh√≥m ${x + 1}`;
          const itemsWrap = document.createElement("div");
          itemsWrap.className = "items";
          for (let y = 0; y < i; y++) {
            const it = document.createElement("div");
            it.className = "item";
            it.textContent = icons[iconIndex];
            it.setAttribute("role", "button");
            it.tabIndex = 0;
            it.addEventListener("click", () => {
              animateCount(it);
            });
            itemsWrap.appendChild(it);
          }
          gEl.appendChild(title);
          gEl.appendChild(itemsWrap);
          groupsArea.appendChild(gEl);
        }
      }
      function animateCount(el) {
        el.animate([{ transform: "scale(1)" }, { transform: "scale(1.15)" }, { transform: "scale(1)" }], { duration: 280 });
        speak("1");
      }

      groupsCountEl.addEventListener("input", renderGroups);
      itemsPerGroupEl.addEventListener("input", renderGroups);
      prevIcon.addEventListener("click", () => { iconIndex = (iconIndex - 1 + icons.length) % icons.length; updatePreview(); renderGroups(); });
      nextIcon.addEventListener("click", () => { iconIndex = (iconIndex + 1) % icons.length; updatePreview(); renderGroups(); });
      speakBtn.addEventListener("click", () => { const g = Number(groupsCountEl.value); const i = Number(itemsPerGroupEl.value); speak(toVietnamese(g) + " nh√¢n " + toVietnamese(i)); });
      resetBtn.addEventListener("click", () => { groupsCountEl.value = 3; itemsPerGroupEl.value = 4; iconIndex = 0; updatePreview(); renderGroups(); });
      shuffleBtn.addEventListener("click", () => { groupsCountEl.value = Math.floor(Math.random() * 7) + 1; itemsPerGroupEl.value = Math.floor(Math.random() * 7) + 1; iconIndex = Math.floor(Math.random() * icons.length); updatePreview(); renderGroups(); });

      // --------------------------
      // Quiz (learn)
      // --------------------------
      const quizStories = [
        { story: "Mai c√≥ 3 gi·ªè t√°o, m·ªói gi·ªè ƒë·ªÅu c√≥ 4 qu·∫£. C√¥ ·∫•y mu·ªën ƒëem t·∫•t c·∫£ t√°o ƒëi chia cho b·∫°n b√®. H·ªèi Mai c√≥ t·∫•t c·∫£ bao nhi√™u qu·∫£ t√°o?", g: 3, it: 4 },
        { story: "Nam c√≥ 5 t√∫i k·∫πo, m·ªói t√∫i ch·ª©a 2 chi·∫øc. C·∫≠u ·∫•y mu·ªën ƒë·∫øm xem m√¨nh c√≥ bao nhi√™u chi·∫øc k·∫πo.", g: 5, it: 2 },
        { story: "Trong v∆∞·ªùn, b√† Lan tr·ªìng 4 h√†ng hoa, m·ªói h√†ng c√≥ 3 c√¢y üåπ. H·ªèi t·∫•t c·∫£ c√≥ bao nhi√™u c√¢y hoa?", g: 4, it: 3 },
        { story: "C·ª≠a h√†ng c√≥ 6 h·ªôp chu·ªëi, m·ªói h·ªôp 5 qu·∫£. Nh√¢n vi√™n c·∫ßn ƒë·∫øm t·ªïng s·ªë qu·∫£ chu·ªëi trong c·ª≠a h√†ng.", g: 6, it: 5 },
        { story: "M·ªôt chu·ªìng c√≥ 3 con ch√≥, m·ªói con ƒëang gi·ªØ 4 chi·∫øc x∆∞∆°ng. H·ªèi trong chu·ªìng c√≥ t·ªïng c·ªông bao nhi√™u chi·∫øc x∆∞∆°ng?", g: 3, it: 4 }
      ];
      let quizQ = [];
      let currentQuiz = 0;
      let score = 0;

      function makeQuiz() {
        quizQ = [];
        score = 0;
        const used = new Set();
        while (quizQ.length < quizStories.length) {
          const idx = Math.floor(Math.random() * quizStories.length);
          if (!used.has(idx)) { used.add(idx); quizQ.push(quizStories[idx]); }
        }
        currentQuiz = 0;
        showQuiz();
      }
      function showQuiz() {
        if (!quizQ.length) return;
        const q = quizQ[currentQuiz];
        quizStep.textContent = currentQuiz + 1;
        quizQuestion.textContent = q.story;
        const correct = q.g * q.it;
        const wrong = correct + (Math.random() < 0.5 ? -(Math.floor(Math.random() * 3) + 1) : (Math.floor(Math.random() * 3) + 1));
        if (Math.random() < 0.5) {
          answerA.textContent = correct; answerA.dataset.correct = "1";
          answerB.textContent = wrong; answerB.dataset.correct = "";
        } else {
          answerB.textContent = correct; answerB.dataset.correct = "1";
          answerA.textContent = wrong; answerA.dataset.correct = "";
        }
        quizFeedback.textContent = "";
      }
      [answerA, answerB].forEach((btn) => btn.addEventListener("click", () => {
        if (btn.dataset.correct) { score++; quizFeedback.textContent = "Ch√≠nh x√°c! üéâ"; quizFeedback.style.color = "green"; }
        else { quizFeedback.textContent = "Ch∆∞a ƒë√∫ng, th·ª≠ l·∫ßn sau nh√© üòä"; quizFeedback.style.color = "#cc4b4b"; }
        setTimeout(() => {
          currentQuiz++;
          if (currentQuiz < quizQ.length) showQuiz();
          else {
            quizFeedback.style.color = "#ff6f00";
            quizFeedback.textContent = `üéâ B·∫°n ƒë√£ ho√†n th√†nh! B·∫°n tr·∫£ l·ªùi ƒë√∫ng ${score}/${quizQ.length} c√¢u.`;
            retryQuizBtn.style.display = "inline-block";
          }
        }, 900);
      }));
      retryQuizBtn.addEventListener("click", () => { makeQuiz(); quizFeedback.textContent = ""; retryQuizBtn.style.display = "none"; });
      speakQuizBtn.addEventListener("click", () => { if (quizQ[currentQuiz]) speak(quizQ[currentQuiz].story); });

      // --------------------------
      // Multiplication table (1..12) + theme
      // --------------------------
      const multiplicationButtons = document.getElementById("multiplicationButtons");
      const multiplicationDisplay = document.getElementById("multiplicationDisplay");
      const readTableBtn = document.getElementById("readTableBtn");
      let currentTable = 1;
      let multiplicationInited = false;

      function multiplicationButtonsHasChildren(){ return multiplicationButtons && multiplicationButtons.children.length > 0; }

      function initMultiplicationButtons() {
        if (multiplicationInited) return;
        multiplicationInited = true;
        // create buttons 1..12
        for (let n = 1; n <= 9; n++) {
          const btn = document.createElement("button");
          btn.textContent = n;
          btn.addEventListener("click", () => {
            currentTable = n;
            updateTable(n);
            highlightActive(btn);
          });
          multiplicationButtons.appendChild(btn);
        }
      }

      /*function updateTable(n) {
        if (n) currentTable = n;
        multiplicationDisplay.innerHTML = "";
        const maxRow = 12;
        for (let i = 1; i <= maxRow; i++) {
          const line = document.createElement("div");
          line.textContent = `${currentTable} √ó ${i} = ${currentTable * i}`;
          line.tabIndex = 0;
          line.addEventListener("click", () => speak(`${currentTable} nh√¢n ${i} b·∫±ng ${currentTable * i}`));
          multiplicationDisplay.appendChild(line);
        }
        updateTableTheme();
      }*/

      function updateTable() {
        multiplicationDisplay.innerHTML = "";
        for (let i = 1; i <= 10; i++) {
            const line = document.createElement("div");
            line.textContent = `${currentTable} √ó ${i} = ${currentTable * i}`;
            line.addEventListener("click", () => {
            speak(`${currentTable} nh√¢n ${i} b·∫±ng ${currentTable * i}`);
            });
            multiplicationDisplay.appendChild(line);
        }
        updateTableTheme();
        }

      /*function updateTableTheme() {
        const pastelColors = [
          "#ffe6f2", "#fff0da", "#e7ffda", "#daf3ff",
          "#f4daff", "#ffedd8", "#d8fff1", "#f9d8ff",
          "#ffe4da", "#e8f7ff", "#fff0f0", "#f3ffe8"
        ];
        const display = multiplicationDisplay;
        display.style.background = pastelColors[(currentTable - 1) % pastelColors.length];
        display.style.padding = "16px";
        display.style.borderRadius = "16px";
      }*/
      function updateTableTheme() {
        const pastelColors = [
            "#ffeff5", "#fff3d9", "#e7ffe5", "#dff5ff",
            "#f4e4ff", "#ffe9d6", "#d6fffa", "#ffe3fb", "#ffe9e9"
        ];
        multiplicationDisplay.style.background = pastelColors[currentTable - 1];
        multiplicationDisplay.style.border = "3px solid #ffc6db";
        multiplicationDisplay.style.borderRadius = "18px";
        multiplicationDisplay.style.padding = "18px";
        multiplicationDisplay.style.transition = "0.3s";
        }

      function highlightActive(activeBtn) {
        document.querySelectorAll("#multiplicationButtons button").forEach((b) => b.classList.remove("active"));
        if (activeBtn) activeBtn.classList.add("active");
      }

      readTableBtn.addEventListener("click", () => {
        let text = "";
        for (let i = 1; i <= 9; i++) text += `${currentTable} nh√¢n ${i} b·∫±ng ${currentTable * i}. `;
        speak(text);
      });

      // --------------------------
      // Matching game (cards)
      // --------------------------
      const gameArea = document.getElementById("gameArea");
      const newGameBtn = document.getElementById("newGameBtn");
      let firstCard = null;
      let lockBoard = false;

      function createGame() {
        gameArea.innerHTML = "";
        const cards = [];
        // create 6 pairs (we show 8 cards = 4 pairs earlier; now create 6 pairs for more variety)
        const pairsCount = 6;
        for (let i = 1; i <= pairsCount; i++) {
          const result = currentTable * i;
          cards.push({ text: `${currentTable} √ó ${i}`, value: result, type: "exp" });
          cards.push({ text: String(result), value: result, type: "ans" });
        }
        // shuffle
        cards.sort(() => Math.random() - 0.5);
        // create elements
        cards.forEach((c) => {
          const cardEl = document.createElement("div");
          cardEl.className = "game-card";
          cardEl.textContent = c.text;
          cardEl.dataset.value = c.value;
          cardEl.dataset.type = c.type;
          gameArea.appendChild(cardEl);
        });
        setupCardEvents();
      }

      function setupCardEvents() {
        document.querySelectorAll(".game-card").forEach((card) => {
          // remove previous handlers by cloning (safe)
          const newCard = card.cloneNode(true);
          card.parentNode.replaceChild(newCard, card);
        });
        document.querySelectorAll(".game-card").forEach((card) => {
          card.addEventListener("click", () => {
            if (lockBoard || card.classList.contains("matched")) return;
            card.style.background = "#fff2c2";
            if (!firstCard) {
              firstCard = card;
            } else {
              lockBoard = true;
              if (firstCard.dataset.value === card.dataset.value && firstCard.dataset.type !== card.dataset.type) {
                // matched
                firstCard.classList.add("matched");
                card.classList.add("matched");
                speak("Ch√≠nh x√°c!");
                setTimeout(() => {
                  firstCard.style.background = "";
                  card.style.background = "";
                }, 300);
              } else {
                speak("Ch∆∞a ƒë√∫ng r·ªìi, th·ª≠ l·∫°i nh√©!");
                setTimeout(() => {
                  firstCard.style.background = "";
                  card.style.background = "";
                }, 400);
              }
              setTimeout(() => { firstCard = null; lockBoard = false; checkWin(); }, 500);
            }
          });
        });
      }

      newGameBtn.addEventListener("click", () => { createGame(); startTimer(); });

      // --------------------------
      // Timer + stickers
      // --------------------------
      let timeLeft = 30;
      let timer = null;
      let stickers = Number(localStorage.getItem("stickers") || 0);
      document.getElementById("stickerCount").textContent = stickers;

      function startTimer() {
        clearInterval(timer);
        timeLeft = 30;
        updateTimerDisplay();
        timer = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          if (timeLeft <= 0) {
            clearInterval(timer);
            endGame(false);
          }
        }, 1000);
      }
      function updateTimerDisplay() {
        const t = document.getElementById("timerDisplay");
        t.textContent = `‚è±Ô∏è ${timeLeft}s`;
        if (timeLeft <= 10) t.classList.add("blink"); else t.classList.remove("blink");
      }
      function checkWin() {
        const unmatched = document.querySelectorAll(".game-card:not(.matched)");
        if (unmatched.length === 0) {
          endGame(true);
        }
      }
      function endGame(win) {
        clearInterval(timer);
        if (win) {
          speak("Tuy·ªát v·ªùi! Con ƒë√£ th·∫Øng!");
          earnSticker();
        } else {
          speak("H·∫øt th·ªùi gian r·ªìi! Ch∆°i l·∫°i nh√©!");
        }
      }
      function earnSticker() {
        stickers++;
        localStorage.setItem("stickers", stickers);
        document.getElementById("stickerCount").textContent = stickers;
        const earned = document.createElement("div");
        earned.textContent = "‚≠ê";
        earned.className = "sticker-earned";
        earned.style.position = "fixed";
        earned.style.left = "50%";
        earned.style.top = "40%";
        earned.style.transform = "translate(-50%, -50%)";
        earned.style.zIndex = "9999";
        document.body.appendChild(earned);
        setTimeout(() => earned.remove(), 900);
      }

      // --------------------------
      // Initialization
      // --------------------------
      updatePreview();
      renderGroups();
      makeQuiz();
      // default: show learn
      showLearn();

      // when user switches to tables, initialize buttons if necessary
      initMultiplicationButtons();
      highlightActive(document.querySelectorAll("#multiplicationButtons button")[0]);
      updateTable(1);
      createGame();

      // accessibility
      document.addEventListener("keydown", (e) => { if (e.key === " ") { e.preventDefault(); speakBtn.click(); } });

    </script>
  </body>
</html>
