<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Vui h·ªçc ph√©p nh√¢n</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Baloo 2", cursive;
        background: #fdf6fb;
      }
      #shootGame {
        max-width: 900px;
        margin: 0 auto;
        background: linear-gradient(180deg, #ffe4f0, #fff0f6);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 8px 30px rgba(50, 30, 50, 0.06);
      }
      .control-panel {
        display: flex;
        gap: 18px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      .control-label {
        margin-right: 10px;
        font-weight: bold;
      }
      .speed-btn {
        padding: 6px 16px;
        border-radius: 12px;
        border: 2px solid #ffb100;
        background: #fff;
        cursor: pointer;
        margin: 0 4px;
        font-size: 14px;
      }
      .speed-btn.active {
        background: #ff71a5;
        border: none;
        color: #fff;
      }
      .question-box {
        background: linear-gradient(180deg, #fff, #fff0f6);
        border-radius: 14px;
        padding: 12px 20px;
        font-size: 34px;
        font-weight: 800;
        color: #ff6a8b;
        box-shadow: 0 6px 12px rgba(255, 110, 160, 0.12);
        min-width: 220px;
        text-align: center;
        margin-top: 12px;
      }
      #balloonArea {
        margin-top: 14px;
        width: 100%;
        height: 360px;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.6),
          rgba(255, 255, 255, 0.15)
        );
        border: 1px solid rgba(255, 200, 220, 0.4);
      }
      .balloon {
        position: absolute;
        width: 68px;
        height: 68px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 800;
        color: #053d5a;
        text-shadow: 0 0 3px #ffffffaa;
        cursor: pointer;
        background: radial-gradient(
          circle at 35% 35%,
          #ffffffee 8%,
          #8fe2ffdd 40%,
          #3bb8ffdd 85%
        );
        border: 3px solid #47bfff;
        box-shadow: inset -6px -8px 14px rgba(0, 90, 160, 0.18),
          0 0 14px rgba(80, 190, 255, 0.55), 0 8px 18px rgba(0, 60, 100, 0.1);
        user-select: none;
        transform: translateY(0);
        transition: transform 0.14s ease, box-shadow 0.14s ease;
      }
      .balloon:hover {
        transform: scale(1.12) translateY(-4px);
        box-shadow: 0 14px 28px rgba(255, 110, 160, 0.18);
      }
      @keyframes floatUp {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-520px);
          opacity: 0;
        }
      }
      .pop {
        animation: popBalloon 0.65s ease-out forwards;
        transform-origin: center center;
        z-index: 100;
      }
      @keyframes popBalloon {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        40% {
          transform: scale(1.6);
          opacity: 1;
        }
        100% {
          transform: scale(0.35);
          opacity: 0;
        }
      }
      .candy-splash {
        position: absolute;
        font-size: 20px;
        pointer-events: none;
        transform-origin: center;
        opacity: 1;
      }
      @keyframes candyFly {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(var(--dx, 0), var(--dy, 0)) scale(0.45)
            rotate(20deg);
        }
      }
      .controls-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn {
        background: #ff6a8b;
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
      .btn.secondary {
        background: #ffd166;
        color: #4b3621;
      }
      .level-badge {
        background: #fff0f0;
        padding: 6px 10px;
        border-radius: 10px;
        font-weight: 800;
        color: #ff6a8b;
      }
    </style>
  </head>
  <body>
    <div id="shootGame">
      <div class="control-panel">
        <div>
          <span class="control-label">‚ö° T·ªëc ƒë·ªô:</span>
          <button class="speed-btn active" data-speed="4500">Ch·∫≠m</button>
          <button class="speed-btn" data-speed="3000">V·ª´a</button>
          <button class="speed-btn" data-speed="1800">Nhanh</button>
        </div>
        <div>üíé <span id="shootReward">0</span></div>
        <div>üèÜ <span id="shootHighScore">0</span></div>
        <div class="controls-row">
          <label>Level</label>
          <div id="levelBadge" class="level-badge">1</div>
        </div>
      </div>

      <div id="shootQuestion" class="question-box" aria-live="polite">
        5 √ó 7 = ?
      </div>
      <div
        id="balloonArea"
        role="application"
        aria-label="khu v·ª±c bong b√≥ng"
      ></div>

      <div
        style="
          margin-top: 12px;
          display: flex;
          gap: 12px;
          justify-content: center;
        "
      >
        <button id="startBtn" class="btn">B·∫Øt ƒë·∫ßu</button>
        <button id="stopBtn" class="btn secondary">D·ª´ng</button>
        <button id="resetHighBtn" class="btn secondary">ƒê·∫∑t l·∫°i k·ª∑ l·ª•c</button>
      </div>
    </div>

    <script>
      (() => {
        const popSound = new Audio(
          "https://assets.mixkit.co/sfx/preview/mixkit-pop-106.mp3"
        );
        popSound.volume = 0.55;

        const balloonArea = document.getElementById("balloonArea");
        const questionEl = document.getElementById("shootQuestion");
        const shootRewardEl = document.getElementById("shootReward");
        const shootHighEl = document.getElementById("shootHighScore");
        const levelBadge = document.getElementById("levelBadge");

        let shootScore = 0;
        let shootHighScore =
          Number(localStorage.getItem("shootHighScore")) || 0;
        shootHighEl.textContent = shootHighScore;

        let shootCorrectAnswer = null,
          spawnIntervalId = null,
          active = false,
          currentLevel = 1,
          balloonIds = 0;
        let usedRecentQuestions = new Set(),
          baseDuration = parseInt(
            document.querySelector(".speed-btn.active").dataset.speed
          );
        let currentAnswerPool = [],
          correctBalloonSpawned = false;

        document.querySelectorAll(".speed-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".speed-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            baseDuration = parseInt(btn.dataset.speed);
            if (active) restartSpawnInterval();
          });
        });

        document
          .getElementById("startBtn")
          .addEventListener("click", startShootGame);
        document
          .getElementById("stopBtn")
          .addEventListener("click", stopShootGame);
        document
          .getElementById("resetHighBtn")
          .addEventListener("click", () => {
            localStorage.removeItem("shootHighScore");
            shootHighScore = 0;
            shootHighEl.textContent = 0;
          });

        function rand(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function randomFromSet(arr) {
          return arr[Math.floor(Math.random() * arr.length)];
        }

        function startShootGame() {
          stopShootGame();
          shootScore = 0;
          currentLevel = 1;
          levelBadge.textContent = currentLevel;
          shootRewardEl.textContent = shootScore;
          nextQuestion();
          active = true;
        }

        function stopShootGame() {
          active = false;
          clearInterval(spawnIntervalId);
          spawnIntervalId = null;
          balloonArea.innerHTML = "";
          usedRecentQuestions.clear();
        }

        function nextQuestion() {
          balloonArea.innerHTML = "";
          let a, b, key;
          do {
            a = rand(1, 9);
            b = rand(1, 10);
            key = `${a}x${b}`;
          } while (
            usedRecentQuestions.has(key) &&
            usedRecentQuestions.size < 80
          );
          usedRecentQuestions.add(key);
          if (usedRecentQuestions.size > 80) usedRecentQuestions.clear();
          shootCorrectAnswer = a * b;
          questionEl.textContent = `${a} √ó ${b} = ?`;

          const answers = new Set([shootCorrectAnswer]);
          while (answers.size < 6) answers.add(rand(1, 90));
          currentAnswerPool = [...answers].sort(() => Math.random() - 0.5);

          correctBalloonSpawned = false;
          spawnBalloonBatch();
          restartSpawnInterval();
        }

        function restartSpawnInterval() {
          clearInterval(spawnIntervalId);
          spawnIntervalId = setInterval(() => {
            if (active) spawnBalloonBatch();
          }, Math.max(800, baseDuration));
        }

        function spawnBalloonBatch() {
          const batchSize = rand(3, 5);
          const positions = [];
          const correctIndex = rand(0, batchSize - 1);

          for (let i = 0; i < batchSize; i++) {
            let num =
              i === correctIndex
                ? shootCorrectAnswer
                : (() => {
                    let c;
                    do {
                      c = randomFromSet(currentAnswerPool);
                    } while (c === shootCorrectAnswer);
                    return c;
                  })();
            let leftPct,
              attempts = 0;
            do {
              leftPct = rand(3, 83);
              attempts++;
            } while (
              positions.some((p) => Math.abs(p - leftPct) < 12) &&
              attempts < 20
            );
            positions.push(leftPct);
            spawnBalloon(num, leftPct);
            if (num === shootCorrectAnswer) correctBalloonSpawned = true;
          }
        }

        function spawnBalloon(num, leftPct = null) {
          const id = ++balloonIds;
          const b = document.createElement("div");
          b.className = "balloon";
          b.dataset.id = id;
          b.textContent = num;

          const palettes = [
            ["#fff6fb", "#ffd7f0"],
            ["#fff9ec", "#fff0d6"],
            ["#f0fff7", "#d8fff0"],
            ["#fff7ff", "#f7e9ff"],
          ];
          const p = palettes[rand(0, palettes.length - 1)];
          b.style.background = `radial-gradient(circle at 28% 28%, ${p[0]}, ${p[1]})`;
          b.style.color = "#7a2a59";
          if (leftPct === null) leftPct = rand(3, 83);
          b.style.left = leftPct + "%";

          const floatDur = Math.max(
            0.9,
            baseDuration / 1000 - (currentLevel - 1) * 0.35
          );
          b.style.animation = `floatUp ${floatDur}s linear forwards`;
          b.style.bottom = -60 - Math.random() * 30 + "px";

          b.addEventListener("click", (ev) => {
            if (!active) return;
            const val = Number(b.textContent);
            if (val === shootCorrectAnswer) {
              // d·ª´ng float animation v√† n·ªï
              b.style.animation = "";
              explodeBalloon(b);
              handleCorrect();
            } else {
              b.style.transform = "translateY(-6px) scale(1.06)";
              b.style.background = "#ffd7d7";
              setTimeout(() => (b.style.transform = ""), 180);
            }
            ev.stopPropagation();
          });

          // remove bong b√≥ng khi bay h·∫øt n·∫øu ch∆∞a b·ªã click ƒë√∫ng
          b.addEventListener("animationend", () => {
            if (b.parentNode && !b.classList.contains("pop")) b.remove();
          });

          balloonArea.appendChild(b);

          setTimeout(() => {
            if (b.parentNode && !b.classList.contains("pop")) b.remove();
          }, Math.max(6000, floatDur * 1000 + 900));
        }

        function explodeBalloon(balloonEl) {
          try {
            popSound.currentTime = 0;
            popSound.play();
          } catch (e) {}

          // Th√™m class pop
          balloonEl.classList.add("pop");

          const areaRect = balloonArea.getBoundingClientRect();
          const rect = balloonEl.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2 - areaRect.left;
          const centerY = rect.top + rect.height / 2 - areaRect.top;

          for (let i = 0; i < 8; i++) {
            const c = document.createElement("div");
            c.className = "candy-splash";
            c.textContent = "üç¨";
            c.style.left = centerX + "px";
            c.style.top = centerY + "px";
            const dx = (Math.random() * 160 - 80).toFixed(0) + "px";
            const dy = (-Math.random() * 160 - 20).toFixed(0) + "px";
            c.style.setProperty("--dx", dx);
            c.style.setProperty("--dy", dy);
            c.style.animation =
              "candyFly 0.85s cubic-bezier(.2,.8,.2,1) forwards";
            balloonArea.appendChild(c);

            setTimeout(() => {
              if (c.parentNode) c.remove();
            }, 1200);
          }

          // Remove bong b√≥ng sau khi pop animation k·∫øt th√∫c
          balloonEl.addEventListener("animationend", () => {
            if (balloonEl.parentNode) balloonEl.remove();
          });
        }

        function handleCorrect() {
          if (!active) return;
          shootScore++;
          shootRewardEl.textContent = shootScore;
          if (shootScore > shootHighScore) {
            shootHighScore = shootScore;
            localStorage.setItem("shootHighScore", shootHighScore);
            shootHighEl.textContent = shootHighScore;
          }
          if (shootScore % 8 === 0) {
            currentLevel++;
            levelBadge.textContent = currentLevel;
          }
          nextQuestion();
        }

        function initPlaceholder() {
          questionEl.textContent = 'Ch·∫°m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ ch∆°i';
          balloonArea.innerHTML = "";
        }
        initPlaceholder();
      })();
    </script>
  </body>
</html>
